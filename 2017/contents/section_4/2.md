# 4-2. review画面を実装する

### 次にtweetに対しての感想を投稿するreview機能を追加しましょう.

### 何か機能を追加する場合は _routing => controller => view_です

## Routing

### routing設定をしましょう

##### config/routes.rb
```ruby
Rails.application.routes.draw do
  devise_for :users
  root to: 'home#index'

  get '/tweet', to: 'tweet#index'
  get '/tweet/new', to: 'tweet#new'
  post '/tweet', to: 'tweet#create'
  get '/tweet/:id', to: 'tweet#show'
  get '/tweet/:id/edit', to: 'tweet#edit'
  put '/tweet/:id', to: 'tweet#update'
  delete '/tweet/:id', to: 'tweet#destroy'

  get '/review/new', to: 'review#new'
  post '/review', to: 'review#create'
  get '/review/:id', to: 'review#show'
  get '/review/:id/edit', to: 'review#edit'
  put '/review/:id', to: 'review#update'
  delete '/review/:id', to: 'review#destroy'
end

```

### 今回は reviewのindexアクションは必要ないので定義しません(ここら辺はさじ加減なので必要だと思えば定義すると良いでしょう)

## Model

### 次にreviewコントローラを作成しましょう、とその前にデータを保存するModelが必要ですね

### Review Modelクラスを作りましょう

```bash
$ rails g model review
Running via Spring preloader in process 8540
      invoke  active_record
      create    db/migrate/20180326091123_create_reviews.rb
      create    app/models/review.rb
      invoke    test_unit
      create      test/models/review_test.rb
      create      test/fixtures/reviews.yml
```

### 次に db/migrate/20180326091123_create_reviews.rb をいじります

##### db/migrate/20180326091123_create_reviews.rb (日付によって異なります)
```ruby
class CreateReviews < ActiveRecord::Migration[5.1]
  def change
    create_table :reviews do |t|
      t.string :value, null: false, default: ""
      t.references :tweet # tweet_idという整数型カラムを追加してくれる便利な機能です
      t.references :user # user_idという整数型カラムを追加してくれる便利な機能です
      t.timestamps
    end
  end
end

```

### migrateをしてMySQLにテーブルを作成します

```bash
$ bundle exec rake db:migrate
```

### 次に Review モデルクラスの定義ファイルを編集しましょう

##### app/models/review.rb
```ruby
class Review < ApplicationRecord
  belongs_to :user
  belongs_to :tweet
end

```

### Reviewモデルと1対多の関係にあるモデルクラスを編集しましょう

##### app/models/tweet.rb
```ruby
class Tweet < ApplicationRecord
  belongs_to :user
  has_many :reviews
end

```

##### app/models/user.rb
```ruby
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable and :omniauthable
  devise :database_authenticatable, :registerable,
    :recoverable, :rememberable, :trackable, :validatable
  
  has_many :tweets
  has_many :reviews
end

```

### Model定義はこれで終了です

## Controller

### さあコントローラーを作成して行きましょう

##### prompt
```bash
$ rails g controller review
Running via Spring preloader in process 8597
      create  app/controllers/review_controller.rb
      invoke  erb
      create    app/views/review
      invoke  test_unit
      create    test/controllers/review_controller_test.rb
      invoke  helper
      create    app/helpers/review_helper.rb
      invoke    test_unit
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/review.coffee
      invoke    scss
      create      app/assets/stylesheets/review.scss
```

### コントローラファイルを編集します

##### app/controllers/review_controller.rb
```ruby
class ReviewController < ApplicationController
  def new
  end

  def create
    if current_user
      @review = Review.create(
        value: params[:review],
        user_id: current_user.id,
        tweet_id: params[:tweet_id]
      )
    else
      redirect_to :action => 'new' # 
    end
  end

  def show
    @review = Review.find(params[:id])
  end

  def edit
    @review = Review.find(params[:id])
  end

  def update
    @review = Review.find(params[:id])
    if @review.user == current_user
      @review.value = params[:review]
      @review.save!
    else
      redirect_to :action => 'new'
    end
  end

  def destroy
    @review = Review.find(params[:id])
    if @review.user == current_user
      @review.destroy
    else
      redirect_to :action => 'new'
    end
  end
end

```

